"use strict";
// Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0
Object.defineProperty(exports, "__esModule", { value: true });
exports.NodeCachingMaterialsManager = void 0;
const cache_material_1 = require("@aws-crypto/cache-material");
const material_management_node_1 = require("@aws-crypto/material-management-node");
const sha512_1 = require("./sha512");
const crypto_1 = require("crypto");
const fromUtf8 = (input) => Buffer.from(input, 'utf8');
const toUtf8 = (input) => Buffer.from(input).toString('utf8');
const cacheKeyHelpers = cache_material_1.buildCryptographicMaterialsCacheKeyHelpers(fromUtf8, toUtf8, sha512_1.sha512);
class NodeCachingMaterialsManager {
    constructor(input) {
        this.getEncryptionMaterials = cache_material_1.getEncryptionMaterials(cacheKeyHelpers);
        this.decryptMaterials = cache_material_1.decryptMaterials(cacheKeyHelpers);
        this._cacheEntryHasExceededLimits = cache_material_1.cacheEntryHasExceededLimits();
        const backingMaterialsManager = input.backingMaterials instanceof material_management_node_1.KeyringNode
            ? new material_management_node_1.NodeDefaultCryptographicMaterialsManager(input.backingMaterials)
            : input.backingMaterials;
        /* Precondition: A partition value must exist for NodeCachingMaterialsManager.
         * The maximum hash function at this time is 512.
         * So I create 64 bytes of random data.
         */
        const { partition = crypto_1.randomBytes(64).toString('base64') } = input;
        cache_material_1.decorateProperties(this, {
            ...input,
            backingMaterialsManager,
            partition,
        });
    }
}
exports.NodeCachingMaterialsManager = NodeCachingMaterialsManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGluZ19tYXRlcmlhbHNfbWFuYWdlcl9ub2RlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NhY2hpbmdfbWF0ZXJpYWxzX21hbmFnZXJfbm9kZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsb0VBQW9FO0FBQ3BFLHNDQUFzQzs7O0FBRXRDLCtEQVNtQztBQUNuQyxtRkFPNkM7QUFDN0MscUNBQWlDO0FBQ2pDLG1DQUFvQztBQUVwQyxNQUFNLFFBQVEsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7QUFDOUQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxLQUFpQixFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUV6RSxNQUFNLGVBQWUsR0FBRywyREFBMEMsQ0FDaEUsUUFBUSxFQUNSLE1BQU0sRUFDTixlQUFNLENBQ1AsQ0FBQTtBQUVELE1BQWEsMkJBQTJCO0lBU3RDLFlBQVksS0FBdUQ7UUFtQm5FLDJCQUFzQixHQUErQix1Q0FBc0IsQ0FDekUsZUFBZSxDQUNoQixDQUFBO1FBQ0QscUJBQWdCLEdBQTRCLGlDQUFnQixDQUMxRCxlQUFlLENBQ2hCLENBQUE7UUFDRCxpQ0FBNEIsR0FBRyw0Q0FBMkIsRUFBc0IsQ0FBQTtRQXhCOUUsTUFBTSx1QkFBdUIsR0FDM0IsS0FBSyxDQUFDLGdCQUFnQixZQUFZLHNDQUFXO1lBQzNDLENBQUMsQ0FBQyxJQUFJLG1FQUF3QyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQztZQUN0RSxDQUFDLENBQUUsS0FBSyxDQUFDLGdCQUE2RCxDQUFBO1FBRTFFOzs7V0FHRztRQUNILE1BQU0sRUFBRSxTQUFTLEdBQUcsb0JBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUE7UUFFaEUsbUNBQWtCLENBQUMsSUFBSSxFQUFFO1lBQ3ZCLEdBQUcsS0FBSztZQUNSLHVCQUF1QjtZQUN2QixTQUFTO1NBQ1YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQVNGO0FBbkNELGtFQW1DQyJ9